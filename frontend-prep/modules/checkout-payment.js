define(["jquery","breakpoints","validatorForm","handlebars","ajaxLoader","viewport","checkout","ajaxConfig","overlay","creditCardValidation"],function(e,t,n,r,i,s,o,u,a,f){function Y(t){var n=jQuery.extend({},d,{data:t});e(l).data("payment-data",n)}function Z(t){var n=e(this),r=n.parent().hasClass("tab-paypal"),i=n.parent().hasClass("tab-credit-card"),s=n.parent().hasClass("tab-wire-transfer"),o=n.parent().hasClass("tab-cash-delivery"),u=typeof S.data("country")!="undefined"&&S.data("country")=="it",a=v.data("is-user-logged"),f;t.preventDefault(),et(),G=Q,G.method=n.data("payment-method"),i&&(f=e(n.attr("href")).find(".cardlist"),f&&f.find(".radio-credit-card:first").click(),S.css({display:"block"})),s||o?(N.prop("checked",!1),T.hide()):(N.prop("checked",!0),T.show()),r&&S.hide(),setTimeout(function(){n.parent().hasClass("active")?(G.methodOpen=!0,!r&&G.methodOpen&&(i&&!a||!i)&&S.show(),gt()):(G.methodOpen=!1,F.addClass(c))},100)}function et(){e(".checkout-error-messages li",l).remove(),n.cleansForm(undefined,D)}function tt(t){var n=e(t.target),r=typeof v.data("country")!="undefined"&&v.data("country")=="it",i=e('[name="address-radio"]:checked',".add-billing-address-content").val();e(".shipping-selects-bill-to",l).find(".address-radio:first").click(),n.val()!=="new"&&et();if(n.is(":checked")||n.attr("checked")==="checked")y.hide(),e("."+e(this).data("rel")).slideDown("fast"),S.hide(),r&&(gt(),g.prop("checked",i!==undefined)),e(this).data("rel")==="add-credit-card-content"?S.show():x.hide()}function nt(){var t=e(this),n,r=t.prop("checked")===!0,i,s=v.data("is-user-logged");if(!r){t.prop("checked",!1),e("."+t.data("rel")).slideDown("fast"),i=e(".add-billing-address-content input:radio[name=address-radio]:checked").val(),i===undefined?(x.show(),b.show()):i==="new"&&(x.show(),e("input:radio[name=address-radio]:checked").click());var o=e(".add-billing-address-content .shipping-module"),u=o.find(".shipping-item-order-info");s?(o.removeClass(c),u.removeClass(c)):(o.addClass(c),u.addClass(c),b.show())}else e("."+t.data("rel")).hide(),n=e("."+t.data("rel")).find(".shipping-selects-bill-to"),n&&n.find(".address-radio:first").click(),t.prop("checked",!0);wt()}function rt(t){var n=e(t.target);b.hide();if(n.is(":checked")&&n.hasClass("new-address")||n.hasClass("near-radio"))e(".adca-checkout-billing-address-form-input-state-normal .selectric .label").addClass("gold"),e(".adca-checkout-billing-address-form-input-state-normal .selectric .label").html("Select"),b.show(),F.addClass(c);wt(),e(this).prop("checked",!0),e(".add-billing-address-content .shipping-selects input[name=address-radio]").not(this).removeAttr("checked");if(e('select[name="payment-billing-phone-country"] option:selected').length>1){var r=e('select[name="payment-billing-phone-country"]').find("option:selected").eq(1).val();e('select[name="payment-billing-phone-country"]').find("option:selected").prop("selected",!1),e('select[name="payment-billing-phone-country"] option[value="'+r+'"]').prop("selected",!0)}if(e('select[name="payment-billing-alt-phone-country"] option:selected').length>1){var i=e('select[name="payment-billing-alt-phone-country"]').find("option:selected").eq(1).val();e('select[name="payment-billing-alt-phone-country"]').find("option:selected").prop("selected",!1),e('select[name="payment-billing-alt-phone-country"] option[value="'+i+'"]').prop("selected",!0)}}function it(){var t=e(this),n=t.prop("checked"),r=typeof j!="undefined"&&(j==="it"||j.toLowerCase()==="italy");n?e("."+t.data("rel")).slideDown("fast"):e("."+t.data("rel")).hide(),wt()}function st(){var e=I.is(":checked");e?(q.removeClass(c),R.removeClass(c),U.hasClass("gucci-stay-hidden")||U.removeClass(c)):(q.addClass(c),R.addClass(c),U.addClass(c))}function ot(){var t=e("option:selected",this).attr("data-country-code").toLowerCase(),n={},r,i;r=b.find("input"),i=b.find("select:not(.checkout-payment-address-country)"),r.not(".keep-value").each(function(){e(this).removeClass("error"),e(this).val("")}),i.each(function(){e(this).removeClass("error"),e(this).parents(".selectricWrapper").find(".selectric").removeClass("error"),e(this).find('option[value="0"]').prop("selected",!0),e(this).change(),e(this).selectric("refresh")}),t==="us"?X.removeClass(c):X.addClass(c),j!==t&&(j=t,n={country:j.toUpperCase()},ut(n))}function ut(t){var n,r;n=p,et(),r=i.endPointAccess(n,t),r.done(function(n){var r=n,i=r.data["billing-address-fields"],s=W.attr("name"),o=$.attr("name"),u=F.attr("name"),a=V.attr("name");U.addClass("gucci-stay-hidden"),Object.keys(i).map(function(t){var n=i[t],r=x.find('[name="'+t+'"]'),s=r.prop("tagName"),f=r.attr("type"),l=r.attr("name"),h,p;if(n.show&&s!==undefined){h=r.parents("li"),t=="payment-billing-alt-phone-message-alert"&&U.removeClass("gucci-stay-hidden");switch(s.toLowerCase()){case"button":r.text(n.label);break;case"input":p=h.find("label");if(p.hasClass("noLabel"))break;f==="text"||f==="tel"?o===l?(p.find("span").html(n.label),p.find(".adca-form-label-description").html(n.disclaimer)):u!==l&&p.html(n.label):f==="checkbox"&&p.find("span").html(n.label);break;case"select":p=h.find("label");if(a===l)p.find("span").first().html(n.label);else if(p.find(".more-info").length==1){var d=p.find(".more-info");d.parent().html(n.label+d.get(0).outerHTML)}else p.html(n.label);if(t=="payment-billing-alt-phone-country"||t=="payment-billing-country"||t=="payment-billing-phone-country"||t=="payment-billing-title")break;if(undefined===n.options||n.options.length===0)r.find("option").not('[value="0"]').remove(),r.selectric("init");n.options!==undefined&&n.options.length>0&&(r.find("option").not('[value="0"]').remove(),n.options.map(function(t){e("<option>",{value:t.value}).text(t.label).appendTo(r)}),r.change(),r.selectric("init"))}h.removeClass(c)}else r.parents("li").addClass(c);I.prop("checked",!1)}),wt(),e(".billing-country-phone-selector").find("option").removeAttr("selected"),e(".billing-country-phone-selector").find('option[data-country-code="'+t.country+'"]').attr("selected",!0),e(".billing-country-phone-selector").selectric("refresh"),e("input[name=payment-billing-alternative-phone]").is(":checked")||e(".alt-phone-fields").addClass(c);var f=e(".adca-form-input-container .apo-fpo-text");f.length>0&&("US"==t.country?f.show():f.hide())}),r.fail(function(e,t,n){console.error("The following error occurred: "+t,n)})}function at(t,n){e.each(t,function(t,r){e("<option>",{value:r.value,"data-hasstardateval":r.hasStarDateVal,"data-select-card":"select-card-"+r.name.toLowerCase()}).text(r.name).appendTo(n)})}function ft(t){var n=e(".cards-dropdown"),r=e(".card-switch-form");H.addClass("gold"),n.selectric({optionsItemBuilder:function(e,t){var n='<div class="'+t.attr("data-select-card-class")+'"></div>'+'<span class="card-name">'+e.text+"</span>";return n},onInit:function(){var t,n=e(this).find(":selected"),r=e(this).parent().parent().find(".selectric").find(".label");n.text()==="Select"?(t=n.text(),e(r).addClass("gold")):t='<div class="'+n.attr("data-select-card-class")+'"></div>'+'<span class="card-name">'+n.text()+"</span>";if(e(this).find(":selected").length>0){var i=e(this).find(":selected").data("auth-amount-msg");e("p.submitall").text(e(i).val())}r.html(t)},onClose:function(){var t,n=e(this).find(":selected"),r=e(this).parent().parent().find(".selectric").find(".label");n.text()==="Select"?(t=n.text(),e(r).addClass("gold")):(t='<div class="'+n.attr("data-select-card-class")+'"></div>'+'<span class="card-name">'+n.text()+"</span>",e(r).removeClass("gold")),r.html(t)}}),n.change(function(){var t=e(this),n=t.parents(".form-container"),i="form-switch-container",s=".tooltip-no-card-selected",o=".tooltip-card-selected",u=e("#payment-credit-card-month,#payment-credit-card-year",r);t.find(":selected").index()===0?(n.find(s).show(),n.find(o).hide()):(n.find(s).hide(),n.find(o).show());var a=t.find(":selected").data("tooltip-msg");e("#credit-card-tooltip").text(e(a).val());var f=t.find(":selected").data("auth-amount-msg");e("p.submitall").text(e(f).val()).addClass("_visible")})}function lt(t){var n="#credit-card-"+t.id,i,s,o=e("script#checkout-payment-saved-credit-card").html(),u=r.compile(o);e(".cardlist").find(n).length===0?(s=u(t),e(".new-credit-card-item").before(s),i=e(n),i.on("click touchstart",tt)):i=e(n),e(n).prop("checked",!0)}function ct(t,n){var r=jQuery.extend({},t),s=r["payment-method"]==="credit-card",o=s||r["payment-method"]==="pre-paid-credit-card",u=r["payment-method"]==="bpay"||r["payment-method"]==="wire-transfer"||r["payment-method"]==="cash-on-delivery",a='[name^="payment-"]';r["select-corporate-company"]=e("#select-corporate-company").is(":checked"),e("#select-corporate-company").length>0&&e("#select-corporate-company").is(":checked")?(r["payment-billing-vat-code"]=e("#payment-billing-vat-code").val(),r["payment-billing-company-name"]=e("#payment-billing-company-name").val()):F.is(":visible")&&(r["payment-codice-fiscale"]=e("#input-codice-fiscale").val());if(o){var f="new";s&&(r["payment-credit-card-id"]=e('[name="payment-credit-card-id"]:checked',n.creditcard).val(),f=r["payment-credit-card-id"]);if(f===undefined||f==="new"){r["payment-save-to-address-book-payment"]=e('[name="payment-save-to-address-book-payment"]').is(":checked"),r["payment-select-shipping-information"]=e('[name="payment-select-shipping-information"]').is(":checked");if(!r["payment-select-shipping-information"]){r["payment-billing-address-id"]=e("[name=address-radio]:checked",".add-billing-address-content").val();if(r["payment-billing-address-id"]===undefined||r["payment-billing-address-id"]==="new")r=jQuery.extend(r,i.serializeObject(n.address))}var l=e("#input-credit-card-number").val(),c;l.length>5?(c=l.substring(0,l.length-4).replace(/./g,"*"),c+=l.substring(l.length-4,l.length)):c=l.replace(/./g,"*"),r["payment-credit-card-number-masked"]=c,r["payment-credit-card-cvn"]=e("#input-credit-card-code").val(),r["payment-credit-card-cvn-masked"]=e("#input-credit-card-code").val().replace(/./g,"*"),r["payment-save-to-address-book-payment"]=e('[name="payment-save-to-address-book-payment"]').is(":checked"),r["payment-address-radio"]=e('[name="address-radio"]:checked').val(),r=jQuery.extend(r,i.serializeObject(n.creditcard.find(a)))}}return u&&(r["payment-select-shipping-information"]=e('[name="payment-select-shipping-information"]').is(":checked"),r["payment-select-shipping-information"]||(r["payment-billing-address-id"]=e('[name="address-radio"]:checked',".add-billing-address-content").val(),r["payment-billing-address-id"]==="new"&&(r=jQuery.extend(r,i.serializeObject(n.address))))),r}function ht(s,c){var p,d={};if(!f.validate())return!1;s!==undefined&&s.preventDefault(),c===undefined?e('.add-new-payment-address-form-renamed input[name="payment-billing-ignore-validation"]').val("false"):e('.add-new-payment-address-form-renamed input[name="payment-billing-ignore-validation"]').val(c),et(),B={},B.address=e("#add-new-payment-address"),e(".input-text-form").blur();switch(G.method){case"credit-card":B.creditcard=D;break;case"pre-paid-credit-card":B.creditcard=e("#prepaid-card-order");break;default:typeof G.method!="undefined"||G.method!==""?G.method=G.method:G.method="toBeDefined"}B.corporateOrder=e("div.corporate-company",l),B.extraFiscaleCode=e("div.payment-codice-fiscale-extra",l),d["payment-method"]=G.method,d=ct(d,B),d=o.collectAllValues(d,"payment"),d.action="save-payment",u.mainSubmitMethod()==="GET"&&(d=jQuery.param(d)),p=i.endPointAccess(h,d,"POST"),p.done(function(i){var s=i,u={};o.redirectThePageIfRequired(s);switch(s.payment.status){case"ok":Nt(s.payment),s.payment.data.billing_saved_id!==undefined&&e("#billing_saved_id").val(s.payment.data.billing_saved_id),Y(s.payment.data),o.setModuleStatus("payment",!0,G),Q.paymentDone=!0;var f=s.payment.data["payment-credit-card-id"];typeof f!="undefined"&&f==="new"&&lt(s.payment.data),pt(G.method,s.payment.data),dt(),o.updateOrderDetailsTotals(s.orderDetails),o.closeMe(!0);break;case"validationError":u.fieldsInError=s.payment.field_error_messages,u.errorMessages=s.payment.global_error_messages,e.isEmptyObject(u.fieldsInError)&&u.errorMessages.length>0&&o.scrollToModule(e(".checkout-module")),e.each(B,function(e,t){n.checkThis(t,u)});if(t.is("small")){var c=e(".card-name-form input",l).offset().top,h=parseInt(e("header").css("height").replace("px",""),10);e("html, body").animate({scrollTop:c-h-35},20)}return!1;case"addressError":var p=e('.add-new-payment-address-form input[name="payment-billing-address-address"]').val(),d=e('.add-new-payment-address-form input[name="payment-billing-address-city"]').val(),v=e('.add-new-payment-address-form select[name="payment-billing-province"] option:selected').text(),m=e('.add-new-payment-address-form input[name="payment-billing-address-zip-code"]').val();u.data=[],u.data["payment-billing-address-address"]=p,u.data["payment-billing-address-city"]=d,u.data["payment-billing-province"]=v,u.data["payment-billing-address-zip-code"]=m,u.possibleAddresses=s.payment.possible_addresses;if(Lt(u.possibleAddresses))kt(u.possibleAddresses[0],!0);else{var g=e("#checkout-error-billing-address-not-found-overlay").html(),y=r.compile(g);o.updateOrderDetailsTotals(s.orderDetails),e("#billing-address-not-found-overlay").html(y(u)),Ct(u.data,u.possibleAddresses),e("#add-new-payment-address input").blur(),a.open("#billing-address-not-found-overlay")}return!1}}),p.fail(function(e,t,n){console.error("The following error occurred: "+t+", "+n)})}function pt(t,n){var i=e("script#checkout-payment-summary-"+t).html(),s=r.compile(i),o=s(n);e(".payment-item-selected").remove(),e(".payment-module .payment-module-selected").append(o)}function dt(){k.html(e("#save-change-button-text").val())}function vt(){e(this).val()==="0"?e(this).addClass("gold"):e(this).removeClass("gold")}function mt(){var e=t.is("medium")||t.is("small");G.methodOpen=!e}function gt(){wt()}function yt(){var t;window.location.pathname.indexOf("paypal")===-1?t="CreditCard":t="paypal",e(l).hasClass("filled-out")&&(Q.paymentDone=!0,dt(),o.setModuleStatus("payment",!0,{cardSelected:e("input:radio[name=payment-credit-card-id]:checked").val(),method:t},!1))}function bt(){m.on("click touchstart",tt),g.on("click touchstart",nt),E.on("click touchstart",rt),w.on("click touchstart",it),C.on("click",Z),k.on("click touchend",ht),L.on("click touchend",ht),O.on("click touchend",ht),A.on("click touchend",ht),M.on("click.savecreditcarda touchend.savecreditcard",ht),I.bind("change",st),z.on("change",ot),H.change(vt),ft(),t.change(mt),mt(),wt(),e(".select-shipping-information").prop("checked")===!1&&nt()}function wt(){if(Et()){var e=G.method==="credit-card";e&&St()?Tt():xt()}else F.addClass(c),P.addClass(c)}function Et(){var t=v.data("country")==="it",n=v.data("fiscale-amount"),r=w.is(":checked");if(!t||!n||r)return!1;var i=!0,s=G.method==="credit-card";if(s)if(e("input:radio[name=payment-credit-card-id]:checked").val()==="new"){var o=g.is(":checked"),u=e(".add-billing-address-content input:radio[name=address-radio]:checked").data("country")==="IT";i=o||u||St()}else i=e("input:radio[name=payment-credit-card-id]:checked").data("country")=="IT";return t&&i&&n&&!r}function St(){return!g.is(":checked")&&e(".add-billing-address-content input:radio[name=address-radio]:checked").val()==="new"&&z.val()=="IT"}function xt(){F.removeClass(c),P.addClass(c)}function Tt(){F.addClass(c),P.removeClass(c)}function Nt(t){o.copySopParameters(t),e("#sop_card_type").val(e("#payment-credit-card-type").val()),e("#sop_card_number").val(e("#input-credit-card-number").val()),e("#sop_card_nameOnCard").val(e("#input-credit-card-name").val()),e("#sop_card_cvn").val(e("#input-credit-card-code").val()),e("#payment-save-to-address-book-payment").is(":checked")?e("#sop_save_to_wallet").val("on"):e("#sop_save_to_wallet").val("off");var n=e("#card_expirationMonth").val();e("#card_expirationMonth").val()<10&&(n="0"+n),n=n+"-"+e("#card_expirationYear").val(),e("#sop_card_expiry_date").val(n)}function Ct(t,n){var r=e("[data-use-this-address]",l),i=e("[data-use-original-address]",l),s=e('[name="suggested-shipping-address"]',l),o={};e(n).each(function(){var t=e(this);o[t[0].id]=t[0]}),s.on("click.selection",function(){s.removeClass("_selected"),e(this).addClass("_selected")}),i.data("address",t),i.on("click.use-original-data touchstart",function(t){t.preventDefault();var n=e(this).data("address");kt(n,!0),e(".overlay-background.prevent-document-scroll").hide(),a.close("address-not-found-overlay"),e("#page").removeAttr("style"),e("body").removeClass("overlay-lock")}),r.on("click.use-this-data touchstart",function(t){t.preventDefault();var n=s.filter(":checked").attr("value"),r=o[n];kt(r,!0),e(".overlay-background.prevent-document-scroll").hide(),a.close("address-not-found-overlay"),e("#page").removeAttr("style"),e("body").removeClass("overlay-lock")})}function kt(t,n){t!==undefined&&(e.each(t,function(t,n){if(t!==undefined&&n!==undefined){var r=e('[name="'+t+'"]',l);r.length>0&&(r.is(":text")?r.val(n):r.is("select")&&(r.find('option[value="'+n+'"]').attr("selected",!0),r.selectric("refresh")))}}),At(t),n?ht(undefined,"true"):o.closeMe(!0))}function Lt(e){return e!==undefined&&e[0].autoAccept?!0:!1}function At(t){var n=jQuery.extend({},d,{data:t});t!==undefined&&t.data!==undefined&&t.data.billing_saved_id!==undefined&&e("#billing_saved_id").val(t.data.billing_saved_id)}var l="section.payment-module",c="ckpy-hidden",h="CHECKOUT",p="CHECKOUT_PAYMENT_FORM_FIELDS",d={data:{"payment-method":""}},v=e(".checkout-container"),m=e(".radio-credit-card"),g=e(".select-shipping-information"),y=e(".add-credit-card-content"),b=e(".payment-module .add-shipping-address-content"),w=e(".select-corporate-company"),E=e(".payment-module .address-radio"),S=e(".billing-address-selection"),x=e(".add-billing-address-content"),T=e(".save-address-book"),N=e(".save-to-address-book-payment"),C=e(".tab-item"),k=e(".verify-payment-type"),L=e(".verify-paypal-type"),A=e(".summary-to-be-defined"),O=e(".verify-prepaid-card-type"),M=e(".save-payment-changes.save-address-changes"),_="default",D=e("#credit-card-order"),P=e("#wrapper-codice-fiscale"),H=e(".credit-card-order-form select"),B=[],j=_,F=e(".payment-codice-fiscale-extra",l),I=e(".address-alternative-phone",l),q=e(".adca-checkout-billing-address-form-alt-phone-country",l),R=e(".adca-checkout-billing-address-form-alt-phone",l),U=e(".adca-checkout-billing-address-form-alert-alt-phone",l),z=e(".checkout-payment-address-country",l),W=e(".adca-checkout-billing-address-form-input-address-two-input",l),X=e(".apo-fpo-text",l),V=e(".address-states-us",l),$=e(".adca-form-codice-fiscale-form",l),J={us:[{name:"Visa",value:"visa",hasStarDateVal:!1},{name:"Master Card",value:"master",hasStarDateVal:!1},{name:"Amex",value:"amex",hasStarDateVal:!0},{name:"Switch",value:"switch",hasStarDateVal:!0}],it:[{name:"Visa",value:"visa",hasStarDateVal:!1},{name:"Master Card",value:"master",hasStarDateVal:!1},{name:"Amex",value:"amex",hasStarDateVal:!0},{name:"Switch",value:"switch",hasStarDateVal:!0}],es:[{name:"Visa",value:"visa",hasStarDateVal:!1},{name:"Master Card",value:"master",hasStarDateVal:!1},{name:"Amex",value:"amex",hasStarDateVal:!0},{name:"Switch",value:"switch",hasStarDateVal:!0}],"default":[{name:"Visa",value:"visa",hasStarDateVal:!1},{name:"Master Card",value:"master",hasStarDateVal:!1},{name:"Amex",value:"amex",hasStarDateVal:!0},{name:"Switch",value:"switch",hasStarDateVal:!0}]};v.data("country")!=="undefined"&&(_=v.data("country"),j=v.data("country"));var K=J[_],Q={method:"credit-card",methodOpen:!1,paymentDone:!1},G=Q;return{load:function(){bt(),yt()}}});
