define(["jquery","handlebars","overlay","ajaxConfig","os"],function(e,t,n,r,i){var s=e(".order-history-listings"),o=e("#order-history-cancel-item-overlay").html(),u=e("#order-history-return-overlay").html(),a=e("#order-history-cancel-order-overlay").html(),f=".history-order-item",l="cancelOrder",c="cancelItem",h="returnItem",p,d=r.mainSubmitMethod(),v={filterObjByKey:function(t){var n={};return e.each(t,function(e,t){var r=e.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase();n[r]=t}),n}},m=function(){e(".history-order",s).each(function(t,n){var r=e(this);r.data("data",v.filterObjByKey(e(n).data())),r.find(f).each(function(t,n){var r=e(this);r.data("data",v.filterObjByKey(e(n).data()))})})},g=function(){e(".return-item-show-overlay",s).on("click",function(r){r.preventDefault();var i=t.compile(u),o=e(this).parents(f),a;e("#return-item-overlay",s).remove();var l=o.data("data");l.isMoreThanOne=l["item-quantity"]>1?!0:!1,l["order-id"]=e(this).closest(".history-order").data("order-id"),s.prepend(i(l)),a=e("#return-item-overlay",s),a.data("data",l),C(a),n.open(a)})},y=function(){e(".cancel-order-show-overlay",s).on("click",function(r){r.preventDefault();var i=t.compile(a),o=e(this).parents(".history-order"),u=e(this).parents(".history-order").find(f),l,c=[];e(u).each(function(){c.push(e(this).data("data"))});var h=e(o).data("data");h["order-items"]=c,e("#cancel-order-overlay",s).remove(),s.prepend(i(h)),l=e("#cancel-order-overlay",s),l.data("data",h),k(l),n.open(l)})},b=function(){e(".cancel-item-show-overlay",s).on("click",function(r){r.preventDefault();var i=t.compile(o),u=e(this).parents(f),a;e("#cancel-item-overlay",s).remove();var l=u.data("data");l.isMoreThanOne=l["item-quantity"]>1?!0:!1,l["order-id"]=e(this).closest(".history-order").data("order-id"),s.prepend(i(l)),a=e("#cancel-item-overlay",s),a.data("data",l),N(a),n.open(a)})},w=function(){t.registerHelper("itemQty",function(){var e;for(var n=1;n<=this["item-quantity"];n++)e+="<option>"+n+"</option>";return new t.SafeString(e)})},E=function(){p=e("html").hasClass("mobile")||e("html").hasClass("tablet")?!0:!1,p?(e(".tracking-order").removeClass("_open").addClass("_close"),e(".tracking-order .product-detail.accordion-drawer").hide()):e(".tracking-order").removeClass("accordion-item accordion-item-default accordion-item-mutually-exclusive accordion-item-standard accordion-item-medium accordion-item-small")},S=function(){g(),b(),y(),e(".order-cta a").click(function(e){e.stopPropagation()})},x=function(){n.onOpen(function(e){e.find(".order-content").on("click",{context:e.find(".order-content")},T)}),n.onClose(function(e){e.find(".order-content").off("click",{context:e.find(".order-content")},T)})},T=function(e){var t=e.data.context;t.find("select").selectric("close")},N=function(t){var n=t;n.$qtySelect=e("#qty",n),n.$qtySelect.selectric({disableOnMobile:!0,preventWindowScroll:!1}),L(c,n)},C=function(t){var n=t,r=e(".trigger-info",n);n.$qtySelect=e("#qty",n),n.$qtySelect.selectric({disableOnMobile:!0,preventWindowScroll:!1}),r.on("click touchstart",function(t){t.preventDefault(),e(this).parent().next().fadeIn(),e(".trigger-info-text",n).remove()}),L(h,n)},k=function(e){var t=e;L(l,t)},L=function(t,o){var u=e(".item-cancel-reason-text",o),a=400,f=e(".order-overlay-submit-button",o),p=e(".order-overlay-select-reason",o),d=e("#reason",o),v=e(".reason-text-area-counter-container",o),m=e(".reason-text-area-counter-text",o),g=e(".selected-reason",o),y=e(".reason-selection-container",o);f.hide(),g.hide(),p.prop("disabled",!0),o.hasCustomReason=!1,p.on("click",function(t){t.stopPropagation(),t.preventDefault();if(u.css("display")==="none"){var n=d.find(":selected").text();o.selectedReasonId=d.find(":selected").val(),g.find(".selected-reason-text").text(n),g.find(".selected-reason-text other-label").hide()}else g.find(".selected-reason-text .other-label").show(),o.customReasonDescription=u.val();y.hide(),g.show(),e(this).hide(),f.show()}),f.on("click",function(e){e.stopPropagation(),e.preventDefault();var i=o.data("data"),s=b(o,i),u,a;switch(t){case l:u="CANCEL-ORDER-ENDPOINT",a="#cancel-order-overlay";break;case c:u="CANCEL-ITEM-ENDPOINT",a="#cancel-item-overlay";break;case h:u="RETURN-ITEM-ENDPOINT",a="#return-item-overlay"}A(r.getRemoteService(u),s,function(e){e.status==="ok"&&(n.close(a),location.reload("true"))})});var b=function(e,t){var n={"order-id":t["order-id"],"reason-id":e.selectedReasonId?e.selectedReasonId:"","reason-description":e.customReasonDescription?e.customReasonDescription:""};return t["item-id"]&&(n["item-id"]=t["item-id"],n["return-qty"]=e.$qtySelect?e.$qtySelect.find(":selected").text():""),n};u.on("keyup",function(){var t=e(this).val(),n=t.length;if(n>a){var r=t.substr(0,a);e(this).val(r)}else m.text(a-n)}),!e("html").hasClass("tablet")&&i.isIOSDevice()&&(u.on("click",function(){e("#cancel-order-overlay",s).css("height","120%")}),u.on("blur",function(){e("#cancel-order-overlay",s).css("height","auto")})),d.selectric({disableOnMobile:!0,preventWindowScroll:!1}),d.on("change selectric-change",function(){p.prop("disabled",!1),e(this).val()==="other"?(u.fadeIn(),v.css("display","block")):(u.fadeOut(),v.css("display","none"))})},A=function(t,n,r){var i=e.ajax({url:t,type:d,data:jQuery.param({data:n}),dataType:"json"});i.done(function(e){r(e)}),i.error(function(){})};return{load:function(){m(),w(),S(),E(),x()}}});
