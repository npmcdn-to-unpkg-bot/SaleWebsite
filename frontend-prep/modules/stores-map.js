define(["jquery","googleMaps","googleMapsApi","breakpoints","handlebars","ajaxConfig"],function(e,t,n,r,i,s){function O(){}function M(){e(o+","+".selected-store-content").on("click",".stores-map-hours-cta",function(t){var n=e(this).closest(".stores-map-card");t.preventDefault(),D(n),_(n)})}function _(t){var n=t.children(".stores-map-hours");e(".stores-map-card").removeClass("stores-map-card-active"),e(".stores-map-card").removeClass("store-map-hours-expanded"),n.is(":visible")?(t.removeClass("stores-map-card-active"),t.removeClass("store-map-hours-expanded")):(t.addClass("stores-map-card-active"),t.addClass("store-map-hours-expanded")),e(".stores-map-card").not(t).children(".stores-map-hours").slideUp(0),n.slideToggle(400,function(){var n=0;if(r.is("standard")||r.is("large")||r.is("medium")&&!k)r.is("medium")?(n=t.offset().top-e("header").first().height()-10,e("html, body").animate({scrollTop:n},500)):(n=t.offset().top-t.parent().offset().top+e(".stores-search-bar",u).height(),e(".stores-search-column",u).animate({scrollTop:n},500));else if(k){n=t.position().top+350;var i=e(".find-in-store-overlay");i.animate({scrollTop:n},500)}else n=t.offset().top-e("header").first().height()-10,e("html, body").animate({scrollTop:n},500)})}function D(t){var n=t.data("id");e.each(g,function(){this.metadata.active=!1,nt("normal",this)});var r=g[parseInt(n,10)];r.metadata.id==y?(nt("normal",r),y=0):(nt("active",r),y=r.metadata.id)}function P(){var t=e(".stores-map-email-form-wrapper"),n=e(".stores-map-email-form-wrapper");t.hasClass("show")?(t.removeClass("show"),n.find("input").val("").css("-webkit-box-shadow: 0 0 0px 1000px black inset;")):(t.addClass("show"),n.find(".error-text, .stores-map-email-confirmation-text").fadeOut(),n.find("form").fadeIn(),n.find("input").val("").css("-webkit-box-shadow: 0 0 0px 1000px black inset;"),n.find("input").val(""),n.find("input").css("-webkit-appearance","none !important;"),setTimeout(function(){t.find("input").first().focus()},300))}function H(){var t;e("a.button-print").on("click",function(n){n.preventDefault();var r="",i;e(".find-in-store-results-details").length!==0?e(".stores-map-card").each(function(){i=e(this),i.is(":visible")&&(r+=(r===""?"":",")+i.attr("data-storepk"))}):e(".find-in-store-results-details .stores-map-card").each(function(){i=e(this),i.is(":visible")&&(r+=(r===""?"":",")+i.attr("data-storepk"))});if(r==="")return!1;t=window.open(e(this).attr("href")+r,"_blank"),t.focus()})}function B(){j(),ut(),U(),q(),X(),e(".stores-search-result .button-email").on("click",P),H()}function j(){e("#fis-send-email-form, #fis-send-email-form2").submit(function(){var t=e(this),n=e(".find-in-store-product-selected-description .size-select").val(),r=e("#CSRFToken").val(),i=hybris.contextPath+"/store-finder/ajax/product-find-in-store.json?CSRFToken="+r,s=e(".stores-map-cards > .stores-map-card"),o=[];s.each(function(){o.push({distance:e(this).find(".distance-value").text(),availabilityMsg:e.trim(e(this).find(".find-in-store-product-available").text()),storePK:e(this).attr("data-storepk")})});var a={productCode:n,recipientName:e(".stores-map-email-recip-name-input",t).val(),recipientEmail:e(".stores-map-email-address-input",t).val(),stores:o};return t.next(".error-text").fadeOut(),e(".error-text",t).fadeOut(),e.ajax({type:"POST",url:i,dataType:"json",contentType:"application/json",processData:!1,data:JSON.stringify(a),success:function(n){return n.status==="ok"?(e(t,u).fadeOut(function(){t.next(".stores-map-email-confirmation-text").fadeIn()}),!1):(n.status==="error"?e.each(n.field_error_messages,function(n,r){e('input[name="'+n+'"]',t).siblings(".error-text").text(r).fadeIn()}):t.siblings(".error-text").fadeIn(),!1)},error:function(){t.siblings(".error-text").fadeIn()}}),!1})}function F(e){I(),a.hide(),f.show(),p.hide(),S.hide(),E.show(),$(e,null)}function I(){var t=e(".size-select",C);return t=t.val()!="-1"&&t.val()!==null,k&&(t?C.removeClass("size-not-selected"):C.addClass("size-not-selected")),t}function q(){e(".stores-search-bar-input, .stores-map-index-search-input",u).keypress(function(t){var n=t.keyCode?t.keyCode:t.which;n=="13"&&(t.preventDefault(),t.stopPropagation(),R(e(this)))}),e(".stores-search-bar-input-submit, .stores-map-index-search-input-submit",u).on("click touchstart",function(t){t.preventDefault(),t.stopPropagation(),R(e(this).prev())}),e(".stores-search-bar-input, .stores-map-index-search-input",u).on("click touchstart",function(){e(this).val("")})}function R(t){if(e("#flyout-dropdown-size-select").val()=="-1")e("#flyout-dropdown-size").find(".selectric").addClass("error"),e("#flyout-dropdown-size").find(".error-text").css("display","block");else{e("#flyout-dropdown-size").find(".selectric").removeClass("error"),e("#flyout-dropdown-size").find(".error-text").css("display","none");var n=t;n.is("form")&&(n=e("input",n)),F(n.val())}}function U(){var t=!navigator.geolocation;t||e(".use-my-current-link",u).on("click touchstart",function(){var t=e("select.size-select").val();if(t==-1)e(".error-text",C).fadeIn(),N===!1?e(".selectric",C).addClass("error"):e(".size-select",C).addClass("error");else{var n=e(this);I(),navigator.geolocation.getCurrentPosition(function(e){S.hide(),E.show(),a.hide(),f.show(),p.hide(),z(e.coords.latitude,e.coords.longitude)},function(){var t=r.is("small")&&typeof n.data("error-remove-mobile")!="undefined",i=typeof n.data("error-append")!="undefined";if(!i)e(n.data("error-container")).show();else{var s=e(n.data("error-container")).find("p").html(),o=e('<li class="checkout-error-message empty-fields geolocation">').html(s),a=e(".checkout-error-messages","section.shipping-address-order");a.find(".geolocation").remove(),a.append(o)}t&&e(".use-my-current-link",u).remove()})}}),t&&e(".use-my-current-link",u).remove()}function z(e,t){var n=new google.maps.Geocoder,r=new google.maps.LatLng(e,t);n.geocode({latLng:r},function(e,t){if(t==google.maps.GeocoderStatus.OK&&e[1]){var n=e[1].address_components[0];$(n.long_name,r,!0)}})}function W(e,t,n){navigator.geolocation&&navigator.geolocation.getCurrentPosition(function(e){var r=new google.maps.LatLng(e.coords.latitude,e.coords.longitude),i=new google.maps.LatLng(t,n)})}function X(){N===!1&&(e(o,u).delegate("div.stores-map-card","mouseover",function(){var t=e(this).data("id"),n=g[parseInt(t,10)];nt("over",n)}),e(o,u).delegate("div.stores-map-card","mouseout",function(){var t=e(this).data("id"),n=g[parseInt(t,10)];y==n.metadata.id?nt("active",n):nt("normal",n)}))}function V(){e.each(g,function(){this.setMap(null)}),g={}}function $(t,r,a){var f=e(o),c=i.compile(b),h=s.config()["CHECKOUT-SHIPPING-SEARCH-STORE-DATA"],p=e(".stores-map-card",u),d,v,m,g,y,w,T;window.location.protocol=="https:"&&(h=s.config()["CHECKOUT-SECURE-SHIPPING-SEARCH-STORE-DATA"]),l===null&&G(),e(".stores-search-bar-input",u).val(t),k?T={searchData:t,itemId:C.data("item-id"),styleId:C.data("style-id"),sizeId:e(".size-select",A).val()}:T={seachData:t},a&&(T.latitude=r.A,T.longitude=r.F);var N=e.ajax({url:h,type:"GET",data:jQuery.param(T),dataType:"json"});L=t,N.done(function(t){V(),S.show(),E.hide(),f.empty(),t.stores!==null?(x.html(t.stores.length),e(t.stores).each(function(){f.append(c(this)),d=this.latitude,v=this.longitude,m=this.number,g=d+","+v,et(g,m,l)}),p=e(".stores-map-card",u),r?(e(".find-in-store-results").addClass("is-using-location"),p.each(function(){W(e(this),d,v,r)})):e(".find-in-store-results").removeClass("is-using-location"),y=Z(p),w=new n.LatLng(y.latitude,y.longitude),Q(w),K(p,l),e(window).trigger("resize"),t.stores.length>0?(e("#store-no-results").hide(),e("div[class*=stores-search-result-n-of-results]").show(),e("a[class*=button-print]").show(),e("a[class*=button-email]").show()):(e("#store-no-results").show(),e("div[class*=stores-search-result-n-of-results]").show(),e("a[class*=button-print]").hide(),e("a[class*=button-email]").hide()),J(t.stores)):(x.html("0"),e("#store-no-results").show(),e("div[class*=stores-search-result-n-of-results]").show(),e("a[class*=button-print]").hide(),e("a[class*=button-email]").hide())})}function J(t){var n=[],r={};e(t).each(function(){r.name=this.nameStore,r.country=this.country,r.city=this.city,n.push(r)});var i={};i.stores=n,dataLayer.push(i)}function K(t,n){var r=[];e.each(t,function(){var t=new google.maps.LatLng(e(this).data("latitude"),e(this).data("longitude"));r.push(t)});var i=new google.maps.LatLngBounds;for(var s=0;s<r.length;s++)i.extend(r[s]);n.fitBounds(i)}function Q(e){l.setCenter(e)}function G(){g={};var i={mapTypeControl:!1,overviewMapControl:!1,panControl:!1,scaleControl:!1,streetViewControl:!1,maxZoom:18,scrollwheel:!1,zoom:8,zoomControl:!1},s=new n.LatLng(0,0);l=t.buildMap("stores-map",s,i),r.is("small")||r.is("medium")?(l.set("draggable",!1),l.set("disableDoubleClickZoom",!0)):(e(".map-column-zoom-in",u).show(),e(".map-column-zoom-out",u).show(),Y(),google.maps.event.addListener(l,"dragstart",function(){c.hide(),h.hide()}),google.maps.event.addListener(l,"dragend",function(){c.show(),h.show()}))}function Y(){e(".stores-map-column-container",u).on("click",".zoom-control",function(){if(l===undefined)return;var t=l.getZoom();e(this).hasClass("map-column-zoom-in")?l.setZoom(t+1):l.setZoom(t-1)})}function Z(t){var n=0,r=0,i=t.length,s={};return e(t).each(function(){n+=parseFloat(e(this).data("latitude")),r+=parseFloat(e(this).data("longitude"))}),s.latitude=n/i,s.longitude=r/i,s}function et(r,i,s){var o=e(".location-"+i+" .name").html(),u={labelContent:""+i,labelSize:new n.Size(30,45),labelAnchor:new n.Point(15,35),labelVisible:!0,icon:{origin:new google.maps.Point(0,0),url:d,scaledSize:new google.maps.Size(30,45)},optimized:!1,labelInBackground:!1,labelClass:"map-column-icon-label"};t.addMarkerFromLatLng(o,r,function(e){tt(e,i,s,o)},O,s,u,function(){},function(){})}function tt(e,t,n,r){e.metadata={type:"point",id:t,name:r,active:!1},g[t]=e,rt(e)}function nt(e,t){var r=d,i=new n.Point(15,35),s=new google.maps.Size(30,45);e=="over"?(r=v,i=new n.Point(15,35),s=new google.maps.Size(33,48)):e=="active"?(r=m,i=new n.Point(15,35)):e=="normal"&&(i=new n.Point(15,35),r=d),t.setIcon({origin:new google.maps.Point(0,0),url:r,scaledSize:s}),t.labelAnchor=i,t.label.setStyles(),t.label.draw()}function rt(t){n.event.addListener(t,"click",function(){if(r.is("small")||r.is("medium")){if(T===!0)return;T=!0,setTimeout(function(){T=!1},1e3)}e.each(g,function(){this.metadata.active=!1,nt("normal",this)}),t.metadata.id!=y?(nt("active",t),t.metadata.active=!0,y=t.metadata.id):(nt("normal",t),y=0),it(t)}),N===!1&&(n.event.addListener(t,"mouseover",function(){st(t)}),n.event.addListener(t,"mouseout",function(){t.metadata.id!=y&&nt("normal",t),ot(!1)}))}function it(t){var n=t.metadata.id,r=e(".location-"+n,u);_(r)}function st(e){e.metadata.id!=y&&(nt("over",e),ot(e))}function ot(t){var n=e(".stores-map-card",u);e(n).each(function(){e(this).data("id")!=y&&e(this).removeClass("stores-map-card-active")});if(t===!1)return;var r=t.metadata.id,i=e(".location-"+r,u);i.addClass("stores-map-card-active")}function ut(){e(window).resize(function(){at()})}function at(){var t="",n="";r.is("small")&&(t=e(window).width(),n="-30px"),e(".store-near-you-content").css({width:t,left:n})}function ft(){A.on("change selectric-change",".size-select",function(){C.removeClass("size-not-selected"),L!==""&&$(L,null)})}var o=".stores-map-cards",u=e(".stores-map-context"),a=e(".stores-map-index",u),f=e(".stores-map-results",u),l=null,c=e(".map-column-zoom-in",u),h=e(".map-column-zoom-out",u),p=e(".find-in-store-mobile-cta",e("#find-in-store-overlay")),d="/_ui/responsive/theme-gucci/images/map-marker-normal.png",v="/_ui/responsive/theme-gucci/images/map-marker-hover.png",m="/_ui/responsive/theme-gucci/images/map-marker-active.png";e("html").hasClass("retina")&&(d="/_ui/responsive/theme-gucci/images/map-marker-normal-2x.png",v="/_ui/responsive/theme-gucci/images/map-marker-hover-2x.png",m="/_ui/responsive/theme-gucci/images/map-marker-active-2x.png");var g={},y,b=e("#stores-map-card-template").html(),w=s.config()["checkout-shipping-search-store-data"],E=e(".stores-result-loading",u),S=e(".user-actions",f),x=e(".stores-search-result-n-of-results .number",u),T=!1,N=e("html").hasClass("touch"),C=e("#find-in-store-overlay"),k=C.length>0,L="",A=e(".find-in-store-overlay .find-in-store-product-selected-wrapper");return{load:function(){ft(),at(),M(),B()}}});
