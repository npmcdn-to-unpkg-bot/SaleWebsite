define(["jquery","select","os","overlay","breakpoints","handlebars","imageLoader"],function(e,t,n,r,i,s,o){function N(t){function N(t,n){return e.extend({},t,n)}var n,i,u,w,S=x+t;e.ajax({url:S,type:"GET",dataType:"json"}).done(function(t){n=t;var S=N(personalizationJson,n);i=e(T).html(),u=s.compile(i),w=u(S),e(".personalization-overlay-wrapper").html(w),f=e(".personalization-overlay"),l=f.find("select.color-select"),c=f.find(".dots-checkbox"),h=f.find(".initials-content .text-input"),p=f.find(".counter.dynamic"),d=f.find(".block-personalization-info,.product-personalization-content"),v=f.find(".block-personalization-content"),m=f.find(".initials-content._error"),g=h.attr("maxlength"),y=0,b="",E=e(a,f),T="#personalizationTemplate",I(),k(),A(),O(),o.loadImage(e(".image-personalization-image")),r.open("#personalization-overlay")}).fail(function(){console.log("ajax call failed")})}function C(t,n,r){var i="",s,o,u,a,f=e(".dots-checkbox").hasClass("_active"),l=t.length<n.length;return f?l?(r==2?s=t.match(/^(?:[a-zA-Z]\.){0,2}/):s=t.match(/^(?:[a-zA-Z]\.){0,3}/),s&&s.length&&(i=s[0])):(o=t.split(".").join(""),r==2?s=o.match(/[a-zA-Z]{0,2}/):s=o.match(/[a-zA-Z]{0,3}/),a=s[0].split(""),u=a.join("."),u.length&&(i=u+".")):(o=t.split(".").join(""),r==2?s=o.match(/[a-zA-Z]{0,2}/):s=o.match(/[a-zA-Z]{0,3}/),s.length&&(i=s[0])),i}function k(){h.on("input",function(t){var n=e(this).val(),r=e(this).data("last-value"),i=0,s=e(this).data("maxlength");e("body").hasClass(".touch")&&(i=200);if(r!=n)var o=setTimeout(function(){var t=e(".dots-checkbox").hasClass("_active"),i=C(n,r,s);h.val(i),h.data("last-value",i),H(i),q(e("#initials-input"),t)},i)}),c.on("click",_),f.find(".add-this .button").on("click",function(t){var n=e(this).data("style-id");B(t,n)}),f.find(".reset-button .reset").on("click",j),!w&&i.is("small")&&h.on("focus",function(){f.scrollTop()<400&&e(this).val().length===0?f.animate({scrollTop:400},500):f.animate({scrollTop:215},500)}),E.attr("class",u).addClass(e("select.color-select option:selected").val().toLowerCase()),i.change(function(){i.is("medium")&&d.fadeIn("fast",function(){v.css("margin-top","50px")}),h.val().length>0&&i.is("small")&&d.fadeOut("fast",function(){v.css("margin-top","10px")})})}function L(t){var n=e(t.currentTarget),r=n.parents(".product-info-wrapper"),i=r.find(".personalization-custom-overlay"),s=r.find(".size-select option:selected").attr("data-available");U(),s=="false"?(e(".personalize").addClass("hide"),i.length&&i.addClass("hide")):(e(".personalize").removeClass("hide"),i.length&&i.removeClass("hide"))}function A(){var t=".custom-select-parent",r="_select-active";l.selectric({disableOnMobile:!1,onInit:function(){var t=e(".lettering-personalization-content").find(".selectricItems .selected").html();e(".lettering-personalization-content").find(".selectric .label").html(t)},onOpen:function(n){e(n).parents(t).first().addClass(r)},onClose:function(n){var i=e(".lettering-personalization-content").find(".selectricItems .selected").html();e(".lettering-personalization-content").find(".selectric .label").html(i),e(n).parents(t).first().removeClass(r)},optionsItemBuilder:function(e,t){return t.val().length?'<span class="color-preview '+t.val().toLowerCase()+'"></span>'+'<span class="color-title">'+e.text+"</span>":e.text}}),n.supportsTouch()&&M()}function O(){l.change(function(){var t=e(this);E.attr("class",u).addClass(t.val().toLowerCase()),t.closest(".selectric-color-select").find("li").eq(e("option:selected",this).index()).trigger("click")})}function M(){e(".selectricInput").prop("readonly",!0)}function _(t){var n=e(this);n.toggleClass("_active"),D(),F(t)}function D(){var t=h.val(),n="",r=c.hasClass("_active"),i=r?h.attr("data-maxlength")*2-1:h.attr("data-maxlength");if(r){h.attr("maxlength",i);if(t.length>0){E.empty();for(var s=0;s<t.length;s++)n+=t.slice(s,s+1)+".",P(t.slice(s,s+1).toLowerCase()),P("dot");h.val(n)}}else h.attr("maxlength",i),t.length>0&&(h.val(t.split(".").join("")),e(a+" .personalization-custom-dot").remove())}function P(t){e("<div/>",{"class":"personalization-custom-letters personalization-custom-"+t}).appendTo(a)}function H(e){E.empty();for(var t=0;t<e.length;t++)e[t]==="."?P("dot"):P(e[t].toLowerCase())}function B(t,n){var i=h.val(),s=2;c.hasClass("_active")||!c.length&&e(".dots-by-default").val()==="true"?s=h.attr("minlength")*2:s=h.attr("minlength");if(i.length<s)h.addClass("error"),m.addClass("_show");else{var o=e(".add-to-shopping-bag-form"),u=e("input.personalized",o),a=e("input.monogram",o),l=e("input.monogramStyle",o);u.val("true"),a.val(i),l.val(e(".color-select",f).val()),e('.add-to-shopping-bag[data-style-id="'+n+'"]',o).trigger("click"),r.close("#personalization-overlay"),u.val("false"),a.val(""),l.val("")}F(t)}function j(e){i.is("small")&&d.fadeIn("slow",function(){v.css("margin-top","50px")}),h.removeClass("error"),m.removeClass("_show"),p.text(parseInt(0,10)),E.empty(),S=!1,h.val(""),b="",F(e)}function F(e){e&&e.preventDefault&&e.preventDefault()}function I(){var t=c.length,n=c.hasClass("_active"),r=e(".dots-by-default").val(),i=h.attr("data-maxlength")*2-1,s=h.attr("data-maxlength");r!="false"?t==0?g=i:n!="false"?g=i:g=s:g=s,h.attr("maxlength",g)}function q(t,n){var r=e(".counter.dynamic"),i=t.val().length;t.length&&(n?r.html(parseInt(i/2)):r.html(i))}function R(){var t=e("body");t.on("change",".size-select",L),e("#product-details-selected-size").length>0&&e(".size-select").length>0&&e("#product-details-selected-size").val(e(".size-select").val()),t.on("selectric-change",'select[name="size"]',function(e){L(e)}),t.on("click",".personalization-custom-overlay",function(t){personalizationJson&&typeof personalizationJson!="undefined"&&e("body").hasClass("page-shopLookPage")&&(personalizationJson.productName=e(this).parents(".product-info-wrapper").find(".stl-id-title").text()),n.isMobileDevice(),!e("html").hasClass("mobile")&&!e("html").hasClass("tablet")&&h.focus(),t&&t.preventDefault&&t.preventDefault();var r=e(this).parents(".add-to-shopping-bag-form"),i=r.find('[name="size"]'),s=e.trim(e("#flyout-dropdown-size .error-text").text()),o='<span class="error-text size-error">'+s+"</div>";if(e(this).hasClass("_disabled")){var u=r.data("formValidator").getFieldErrorMessage("size",s);U(),r.data("formValidator").appendFieldErrorMessage(i,u)}else if(r.find(".size-scrollable li").eq(0).hasClass("selected")||!r.find(".basic-content-select select").val())U(),!e("html").hasClass("mobile")&&!e("html").hasClass("tablet")?r.find(".selectric-size-select").append(o):r.find(".content-select").append(o);else{var a=e(this).data("style-id");N(a)}})}function U(){e("#size-error").remove(),e(".size-error").remove()}var u="image-personalization-text",a="."+u,f=e(".personalization-overlay"),l=f.find("select.color-select"),c=f.find(".dots-checkbox"),h=f.find(".initials-content .text-input"),p=f.find(".counter.dynamic"),d=f.find(".block-personalization-info,.product-personalization-content"),v=f.find(".block-personalization-content"),m=f.find(".initials-content._error"),g=h.attr("maxlength"),y=0,b="",w=n.isIOSDevice(),E=e(a,f),S=!1,x=hybris.contextPath+"/ajax/monogram/config?styleCode=",T="#personalizationTemplate";return{load:function(){R(),e(".header-nav-bag-list").load(e("#miniCartLayer").attr("data-rolloverPopupUrl")+Math.floor(Math.random()*101)*(new Date).getTime())}}});
