define(["jquery","ajaxConfig","handlebars"],function(e,t){function f(e,t,n,r){return this.$form=e,this.fieldErrorFormat=r||"inline",this.successCallback=t,this.errorCallback=n,this.endpointUri=e.prop("action"),this.preventSubmit=!1,this.bindEvents(),this}function l(e,t,n,r){return new f(e,t,n,r)}var n="global-errors-wrapper",r="global-error-message",i="error-text",s="tooltip-help",o="tooltip-message error-text",u="error",a=Modernizr.touch;return f.prototype.bindEvents=function(){var t;this.$form.attr("id")&&(t="#"+this.$form.attr("id")),t?e("body").off("submit.formvalidator",t,this.submitHandler).on("submit.formvalidator",t,e.proxy(this.submitHandler,this)):this.$form.on("submit.formvalidator",e.proxy(this.submitHandler,this))},f.prototype.submitHandler=function(e){e.preventDefault();if(this.preventSubmit)return;this.preventSubmit=!0,this.endpointUri=this.$form.prop("action"),this.ajaxCall()},f.prototype.ajaxCall=function(){var n,r;this.clearErrorMessages(),n=this.getJsonData(),r=e.ajax({url:this.endpointUri,type:t.mainSubmitMethod(),data:n,dataType:"json"}),r.done(e.proxy(this.onAjaxSuccess,this)),r.fail(e.proxy(this.onAjaxError,this))},f.prototype.onAjaxSuccess=function(e){var t=this.filterResponse(e);t.status==="ok"?this.onValidationSuccess(t):(this.$form.addClass("form-error"),this.onValidationError(t)),this.preventSubmit=!1},f.prototype.filterResponse=function(t){if(t.status)return t;var n=Object.keys(t),r;return e.each(n,function(e,n){var i=t[n];i.status&&(r=i)}),r},f.prototype.onAjaxError=function(){this.preventSubmit=!1},f.prototype.onValidationError=function(t){this.displayFieldErrorMessages(t.field_error_messages||{}),e.isFunction(this.errorCallback)&&this.errorCallback(t)},f.prototype.onValidationSuccess=function(t){e.isFunction(this.successCallback)&&this.successCallback(t)},f.prototype.displayGlobalErrorMessages=function(t){if(!t.length)return;var r=e("<ul>").addClass(n),i=e(".error-message",this.$form),s=this;e.each(t,function(e,t){r.append(s.getGlobalErrorMessage(t))}),i.length?i.html(r):this.$form.prepend(r)},f.prototype.getGlobalErrorMessage=function(t){var n=e("<li>");return n.addClass(r),n.html(t),n},f.prototype.displayFieldErrorMessages=function(t){var n=this.$form,r=this;e.each(t,function(e,t){var i,s;t.length>0&&(i=r.getFieldErrorMessage(e,t)),s=n.find('[name="'+e+'"]'),r.appendFieldErrorMessage(s,i)})},f.prototype.appendFieldErrorMessage=function(e,t){var n;if(e.is("select"))a?(e.addClass(u),e.after(t)):(n=e.parents(".selectricWrapper"),n.find(".selectric").addClass(u),n.append(t));else if(e.is("input")||e.is("textarea"))e.addClass(u),e.after(t)},f.prototype.getFieldErrorMessage=function(e,t){var n;switch(this.fieldErrorFormat){case"tooltip":n=this.getFieldErrorMessageTooltip(e,t);break;case"inline":n=this.getFieldErrorMessageInline(e,t);break;default:n=this.getFieldErrorMessageInline(e,t)}return n},f.prototype.getFieldErrorMessageTooltip=function(t,n){var r=e("<div>"),i=e("<div>");return r.addClass(s),r.prop("id",t+"-"+u),i.addClass(o),i.html(n),r.append(i),r},f.prototype.getFieldErrorMessageInline=function(t,n){var r=e("<span>");return r.addClass(i),r.prop("id",t+"-"+u),r.html(n),r},f.prototype.clearErrorMessages=function(){this.$form.removeClass("form-error"),this.$form.find("."+n).remove(),this.$form.find("."+i).remove(),this.$form.find("."+s).remove(),this.$form.find("."+u).removeClass(u)},f.prototype.getJsonData=function(){var t,n={};return t=this.$form.serializeArray(),e.each(t,function(e,t){n[t.name]=t.value}),n},{newInstance:l}});
