define(["jquery","validatorForm","overlay","handlebars","tooltip","ajaxLoader","checkout","ajaxConfig","breakpoints"],function(e,t,n,r,i,s,o,u,a){function st(n){n.preventDefault();var r=I.val(),i,u={};u.data={},u.data["shipping-loggin-email"]=r,u=o.collectAllValues(u,"emailAddress"),u.action="update-email",I.removeClass(p),R.text(r),i=s.endPointAccess(et,u,"POST"),i.done(function(n){var i=n,s={};switch(i.emailAddress.status){case"ok":U.hide(),R.show(),q.removeClass(h),e("."+c).addClass(h),ut(r,!0),o.copySopParameters(i.emailAddress);break;case"validationError":return s.fieldsInError=i.emailAddress.field_error_messages,s.errorMessages=i.emailAddress.global_error_messages,V={},typeof U!="undefined"&&(V.loggedInEmail=U),e.each(V,function(e,n){t.checkThis(n,s)}),!1}}),i.fail(function(e,t,n){console.error("The following error occurred: "+t,n)})}function ot(){var t=e(this).hasClass(c),n=R.text();t?(U.hide(),R.show(),q.removeClass(h),e(this).addClass(h),ut()):(R.hide(),U.show(),e(this).addClass(h),e("."+c).removeClass(h),I.val(n),ut("",!1))}function ut(t,n){var r={};t===undefined&&(t=e(".logged-in-info .email").html(),n=!0),r.email=t,o.setModuleStatus("email",n,r,rt)}function at(){y!=="new"&&y!=="near"&&(rt=!0,o.setModuleStatus("shipping",!0,{addressId:y},!1),ft())}function ft(){D.html(e("#save-change-button-text").val()),P.hide()}function lt(t){var n=jQuery.extend({},l,{data:t});t!==undefined&&t.data!==undefined&&t.data.shipping_saved_id!==undefined&&e("#shipping_saved_id").val(t.data.shipping_saved_id),e(f).data("shipping-data",n)}function ct(t,r,i){var s=e("[data-use-this-address]",f),o=e("[data-use-original-address]",f),u=e('[name="suggested-shipping-address"]',f),a={},l=i;e(r).each(function(){var t=e(this);a[t[0].shipping_id]=t[0]}),u.on("click.selection",function(){u.removeClass("_selected"),e(this).addClass("_selected")}),o.data("address",t),o.on("click.use-original-data touchstart",function(t){t.preventDefault();var r=e(this).data("address");ht(l,undefined,!0),e(".overlay-background.prevent-document-scroll").hide(),n.close("address-not-found-overlay"),e("#page").removeAttr("style"),e("body").removeClass("overlay-lock")}),s.on("click.use-this-data touchstart",function(t){t.preventDefault();var r=u.filter(":checked").attr("value"),i=a[r];ht(l,i,!0),e(".overlay-background.prevent-document-scroll").hide(),n.close("address-not-found-overlay"),e("#page").removeAttr("style"),e("body").removeClass("overlay-lock")})}function ht(t,n,r){lt(n),n!==undefined&&(Ht(e('.form-add-shipping-address input[name="shipping_address_line_1"]'),n.shipping_address_line_1),Ht(e('.form-add-shipping-address input[name="shipping_address_line_2"]'),n.shipping_address_line_2),Ht(e('.form-add-shipping-address input[name="shipping_city"]'),n.shipping_city),e(".states-dropdown").find('option[value="'+n.shipping_state_code+'"]').attr("selected",!0),e(".states-dropdown").selectric("refresh"),Ht(e('.form-add-shipping-address input[name="shipping_zip_code"]'),n.shipping_zip_code)),e('.form-add-shipping-address input[name="shipping_ignore_validation"]').length===0&&e(".form-add-shipping-address").append('<input type="hidden" name="shipping_ignore_validation" />'),Ht(e('.form-add-shipping-address input[name="shipping_ignore_validation"]'),"true"),r?dt(e("#shipping-address-order"),t):bt(t,n)}function pt(t){var n={},r=m.filter(":checked").val(),i,o='[name^="shipping_"]',u='[name^="shipping-person"]';return n[nt]=r,r=="new"?(i=s.serializeObject(t.shippingInformation.find(o)),n=jQuery.extend({},n,i)):r=="near"&&(i=s.serializeObject(t.shippingInformation.find(u)),n=jQuery.extend({},n,i)),n.shipping_method_id=e('[name="shipping_method_id"]',f).filter(":checked").val(),typeof t.loggedInEmail!="undefined"&&(i=s.serializeObject(t.loggedInEmail.find(o)),n=jQuery.extend({},n,i)),n}function dt(i,a){var f,l,c;t.cleansForm(undefined,i),V={},V.shippingInformation=i,c=pt(V),l=o.collectAllValues(c,"shipping"),l.action="save-delivery-address",u.mainSubmitMethod()==="GET"&&(l=jQuery.param(l)),f=s.endPointAccess(et,l,"POST"),f.done(function(i){var s=i,u={};p=e("#order-details-availability-item").html(),d=r.compile(p),$.html(d(s)),Bt($.find("a.view-more"));switch(s.shipping.status){case"ok":o.redirectThePageIfRequired(s),lt({data:s.shipping.data}),o.updateOrderDetailsTotals(s.orderDetails),bt(a,s.shipping.data),o.copySopParameters(s.payment),D.html(e("#save-change-button-text").val()),o.isModuleComplete(e("section.payment-module"))&&e("#button-place-order").removeClass("inactive");break;case"validationError":return u.fieldsInError=s.shipping.field_error_messages,u.errorMessages=s.shipping.global_error_messages,e.isEmptyObject(u.fieldsInError)&&u.errorMessages.length>0&&o.scrollToModule(e(".shipping-module")),e("#button-place-order").addClass("inactive"),e.each(V,function(e,n){t.checkThis(n,u)}),!1;case"addressError":var f=e('.form-add-shipping-address input[name="shipping_address_line_1"]').val(),l=e('.form-add-shipping-address input[name="shipping_city"]').val(),c=e('.form-add-shipping-address select[name="shipping_state"] option:selected').text(),h=e('.form-add-shipping-address input[name="shipping_zip_code"]').val();u.data=[],u.data.shipping_address_line_1=f,u.data.shipping_city=l,u.data.shipping_state=c,u.data.shipping_zip_code=h,u.possibleAddresses=s.shipping.possible_addresses;var p=e("#checkout-error-address-not-found-overlay").html(),d=r.compile(p);return o.updateOrderDetailsTotals(s.orderDetails),e("#address-not-found-overlay").html(d(u)),Pt(u.possibleAddresses)?ht(a,u.possibleAddresses[0],!0):(ct(u.data,u.possibleAddresses,a),n.open("#address-not-found-overlay")),e("#button-place-order").addClass("inactive"),it=s.data,!1}}),f.fail(function(e,t,n){console.error("The following error occurred: "+t,n)})}function vt(){e(".checkout-error-messages li",f).remove(),t.cleansForm(undefined,A)}function mt(t,n){var r=y==="new",i=e(".checkout-container").data("country"),s=typeof i!="undefined"&&i==="it";t.preventDefault(),r||vt(),e('.form-add-shipping-address input[name="shipping_ignore_validation"]').length>0&&e('.form-add-shipping-address input[name="shipping_ignore_validation"]').val("false"),dt(M,n)}function gt(t){var n,r=e(this).hasClass(d);if(r)return!1;rt?n="close":n="goPayment",B.blur(),mt(t,n)}function yt(t){var n=e(this).hasClass(d);if(n)return!1;mt(t,"goGifting")}function bt(t,n){var i=e("script#checkout-shipping-saved-address").html(),s=r.compile(i),u=s(n);o.setModuleStatus("shipping",!0,n,rt),e(b).remove(),e(u).insertAfter("div.shipping-edit-area"),rt=!0,ft(),t==="goPayment"?(o.fillIconModule("gifting"),St()):t==="goGifting"?Et():t==="close"&&(o.isModuleComplete(e("section.payment-module"))?o.closeMe():St())}function wt(){var e;rt?e="close":e="goGifting",n.close(),setTimeout(function(){bt(e,it)},500)}function Et(){o.goTo("gifting")}function St(){o.goTo("payment")}function xt(t){var n=e(t.target),r=e(n.data("target"));r.toggleClass(Z)}function Tt(){E.show(),z.hide(),T.hide(),S.show(),w.hide(),D.removeClass(v),D.addClass(d),P.addClass(d)}function Nt(){var t=e(this),n=N.val(),r=n.length>=3,i={},s=G!==n,o=K.val(),u=J!==o;if(!s&&!u)return;n.length===0?(e(".method-selects",f).html(""),w.hide(),S.show()):r&&(s||u)&&(G=n,i[N.attr("name")]=n,J=o,i[K.attr("name")]=K.val(),i.action="list-shipping-mode",kt(i));if(!r||t.hasClass("error"))w.hide(),S.show()}function Ct(){e(".selectricWrapper.selectricOpen").find("select").each(function(){e(this).selectric("close")})}function kt(t){var n=s.endPointAccess(tt,t);n.done(function(t){var n=t,i=n.shippingMethods;if(i.data.methods.length>0)switch(i.status){case"ok":var s="#shipping-method-template-no-radio";i.data.methods.length>1&&(s="#shipping-method-template");var o=e(s).html(),s=r.compile(o),u=e("#delivery-mode-message-"+i.data.methods[0].key).val(),a=e(this).data("description");e(".method-selects",f).html(s(i.data)),S.hide(),w.show(),k=e(".method-radio"),L=e(".method-option"),k.bind("change",Lt)}else w.hide(),S.show()}),n.fail(function(e,t,n){console.error("The following error occurred: "+t,n)})}function Lt(t){var n=e(t.target),r=e(this).val();L.removeClass("_selected"),n.parent().parent().addClass("_selected"),e(".methods-label").css({display:"none"}),e("#delivery-method-message-"+r).css({display:"block"})}function At(t){var n=e(t.target),r=n.closest(".shipping-radio-button"),i=jQuery.extend({},l),s=n.val()==="new",o=n.val()==="near",u=n.val();m.prop("disabled",!1),y=u;if(!s||!o)S.hide(),w.show(),i.data={shipping_id:u};(s||o)&&_.attr("data-country")===undefined&&!It()&&(S.show(),w.hide()),s&&!It()&&(S.show(),w.hide());if(!s&&!o){var a={};a[K.attr("name")]=K.val(),a.shipping_id=n.val(),a[e(this).data("zip-code-field")]=e(this).data("zip-code"),kt(a)}z.hide(),D.addClass(v),D.removeClass(d),P.removeClass(d),n.hasClass("new-radio")?(_.show(),M.show().removeClass("smallCheckout"),O.hide()):n.hasClass("near-radio")?(vt(),M.show().addClass("smallCheckout"),_.hide(),A.hide(),O.show(),E.show(),z.hide(),T.hide(),x.click(function(e){e.preventDefault(),T.show()}),D.removeClass(v),D.addClass(d),P.addClass(d)):(vt(),_.slideUp("fast"),O.slideUp("fast")),e(".shipping-module-selections .shipping-radio-button").removeClass(Y),r.addClass(Y),e(f).data("shipping-data",i)}function Ot(t){var n=e(t.target),r=n.closest(".shipping-radio-button");e(".shipping-selects-bill-to .shipping-radio-button").removeClass(Y),r.addClass(Y)}function Mt(){y=e('input:radio[name = "address-radio"]:checked',f).val();if(y!==undefined&&y!=="new"){w.show(),S.hide();var t=jQuery.extend({},l,{data:{shipping_id:y,shipping_method_id:e('[name="shipping_method_id"]').val()}});e(f).data("shipping-data",t)}else C.click()}function _t(){F.bind("click touchmove",st),q.bind("click touchmove",ot),m.bind("change",At),g.bind("change",Ot),k.bind("change",Lt),D.on("click",gt),P.on("click",yt),H.on("click",wt),N.bind("keyup change",Nt),K.bind("change",Nt),B.bind("focus",Ct),j.bind("change",xt),W.bind("click",Tt),Dt()}function Dt(){e(f+" .stores-map-cards").delegate("a.stores-map-select-cta","click",function(t){t.preventDefault();var n=e(this).prev(),r=e(f+" .address-near"),i=e(".distance-value",n).text(),s=e(f+" .add-shipping-person-content"),o={};i.length>0&&(i+=e(".distance-suffix",n).text()),e(".address-near-title",r).html(n.data("name")),a.is("small")?(e(".store-selected-data1",r).html(n.data("address")),e(".store-selected-data2",r).html(n.data("city")),e(".store-selected-data3",r).html(n.data("telephone")),e(".store-selected-data4",r).html(i)):(e(".store-selected-data1",r).html(n.data("address")),e(".store-selected-data2",r).html(n.data("city")),e(".store-selected-data3",r).html(i)),e(".stores-map-context").hide(),r.show(0,function(){var t=r.offset().top-130;e("html, body").animate({scrollTop:t},500)}),e(".address-near-title",r).html(n.data("name")),e(".store-selected-distance",r).html(n.data("distance")),e(".store-selected-address1",r).html(n.data("addressline1")),e(".store-selected-address2",r).html(n.data("addressline2")),e(".store-selected-address1",r).html(n.data("addressline3")),e(".shipping-person-store-id",s).val(n.data("id")),e(".shipping-person-store-name",s).val(n.data("name")),e(".shipping-person-store-address",s).val(n.data("address")),e(".shipping-person-store-city",s).val(n.data("city")),r.fadeIn(),e(".stores-map-context").fadeOut(),e(f+" .form-add-person-name-to-pick-up").fadeIn(),o[N.attr("name")]=n.data("zipCode"),kt(o),D.addClass(v),D.removeClass(d),P.removeClass(d)})}function Pt(e){return e!=undefined&&e[0].autoAccept?!0:!1}function Ht(e,t){if(e===undefined)return;t===undefined?e.val(""):e.val(t)}function Bt(t){t.each(function(n){var r=e(this);r.on("mouseenter",{index:n},Ft),r.on("mouseleave",{index:n},jt),t.on("click",function(e){e.preventDefault()})})}function jt(t){var n=e(this).attr("href");i.close(n),t.preventDefault()}function Ft(t){var n=e(this).attr("href");return i.open(n),t.preventDefault(),!1}function It(){return hybris.preLoadedDeliveryModes!==undefined&&hybris.preLoadedDeliveryModes=="true"}var f="section.shipping-module",l={data:{shipping_id:0}},c="cancel-edit",h="hide-edit",p="error",d="inactive",v="filled-out",m=e(".shipping-module .shipping-module-selections .address-radio"),g=e(".shipping-selects-bill-to .address-radio"),y,b=".shipping-module-selected",w=e(".shipping-methods"),E=e(".stores-map-wrapper"),S=e("#zip-warning"),x=e(".stores-map-select-cta"),T=e(".address-near"),N=e(".shipping-zip-code-input"),C=e(".new-address","section.shipping-module"),k=e(".method-radio"),L=e(".method-option"),A=e(f+" .form-add-shipping-address"),O=e(f+" .store-near-you-content"),M=e(f+" #shipping-address-order"),_=e(f+" .add-shipping-address-content"),D=e(".button-save-shipping"),P=e(".button-add-gift-message"),H=e(".button-go-gift-message"),B=e(".input-text-form"),j=e(".shipping_more_field_activator",".shipping-module"),F=e(".edit-email-submit"),I=e(".edit-email-form .input-text-form"),q=e(".edit-email"),R=e(".logged-in-info .email"),U=e(".edit-email-form"),z=e(f+" .form-add-person-name-to-pick-up"),W=e(f+" .change-store-link"),X=e(".checkout-container").data("country")==="us"||e(".checkout-container").data("country")==="ca",V=[],$=e(".order-details-availability-totals"),J="",K=e("#shipping-address-order .states-dropdown"),Q=e(f+'[name="shipping_method_id"]'),G="",Y="_selected",Z="_active",et="CHECKOUT",tt="CHECKOUT-SHIPPING-METHODS",nt="shipping_id",rt=!1,it={};return{load:function(){_t(),Mt(),ut(),at()}}});
